trigger: none   # run manually

pool:
  name: Default
  demands:
    - Agent.OS -equals Windows_NT

variables:
  TF_VERSION: '1.6.6'

steps:
- checkout: self

- task: TerraformInstaller@1
  inputs:
    terraformVersion: $(TF_VERSION)

- task: AzureCLI@2
  displayName: "Terraform Bootstrap (State + Providers)"
  inputs:
    azureSubscription: 'ALZ_SC_01'   # <-- ensure underscore matches your service connection
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference = "Stop"

      Write-Host "Agent: $env:AGENT_NAME"
      Write-Host "WorkingDir: $(Get-Location)"
      Write-Host "Listing repo root:"
      Get-ChildItem -Force

      Set-Location "0-bootstrap"
      Write-Host "Now in: $(Get-Location)"
      Get-ChildItem -Force

      # Hard reset local terraform working metadata (safe in CI)
      if (Test-Path ".terraform") { Remove-Item ".terraform" -Recurse -Force }
      if (Test-Path ".terraform.lock.hcl") { Remove-Item ".terraform.lock.hcl" -Force }

      terraform -version

      # Backend init (this is the key step)
      terraform init -input=false -reconfigure -upgrade

      terraform validate
      terraform plan -input=false
      terraform apply -auto-approve -input=false
