trigger: none

pool:
  name: Default
  demands:
    - Agent.OS -equals Windows_NT

variables:
  TF_VERSION: '1.6.6'

steps:
- checkout: self
  clean: true

- task: TerraformInstaller@1
  displayName: Install Terraform
  inputs:
    terraformVersion: $(TF_VERSION)

# INIT (backend + providers)
- task: TerraformTask@5
  displayName: Terraform Init (0-bootstrap)
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '0-bootstrap'
    backendServiceArm: 'ALZ_SC_01'
    backendAzureRmResourceGroupName: 'terraform-storage-rg'
    backendAzureRmStorageAccountName: 'terraformstate277'
    backendAzureRmContainerName: 'tfstatefiles'
    backendAzureRmKey: 'alz/0-bootstrap.tfstate'
    backendAzureRmUseEntraIdForAuthentication: true

# VALIDATE
- task: TerraformTask@5
  displayName: Terraform Validate (0-bootstrap)
  inputs:
    provider: 'azurerm'
    command: 'validate'
    workingDirectory: '0-bootstrap'

- powershell: |
    Write-Host "Commit: $(Build.SourceVersion)"
    Write-Host "Branch: $(Build.SourceBranch)"
    Write-Host "Show parent_management_group_id lines:"
    Select-String -Path "1-management-groups\main.tf" -Pattern "parent_management_group_id"
  displayName: "DEBUG: confirm main.tf used by pipeline"

# PLAN (optional but recommended)
- task: TerraformTask@5
  displayName: Terraform Plan (0-bootstrap)
  inputs:
    provider: 'azurerm'
    command: 'plan'
    workingDirectory: '0-bootstrap'
    environmentServiceNameAzureRM: 'ALZ_SC_01'
    commandOptions: '-out=tfplan'

# APPLY
- task: TerraformTask@5
  displayName: Terraform Apply (0-bootstrap)
  inputs:
    provider: 'azurerm'
    command: 'apply'
    workingDirectory: '0-bootstrap'
    environmentServiceNameAzureRM: 'ALZ_SC_01'
    commandOptions: 'tfplan'
