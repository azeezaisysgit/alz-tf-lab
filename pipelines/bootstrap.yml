trigger: none

pool:
  name: Default
  demands:
    - Agent.OS -equals Windows_NT

workspace:
  clean: all

steps:
- checkout: self
  clean: true

- task: TerraformInstaller@1
  inputs:
    terraformVersion: '1.6.6'

- task: AzureCLI@2
  displayName: "Terraform Bootstrap (State + Providers)"
  inputs:
    azureSubscription: 'ALZ_SC_01'
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
$ErrorActionPreference = "Stop"
Set-Location "0-bootstrap"

# Clean cached terraform metadata
if (Test-Path ".terraform") { Remove-Item ".terraform" -Recurse -Force }
if (Test-Path ".terraform.lock.hcl") { Remove-Item ".terraform.lock.hcl" -Force }

terraform init -input=false -reconfigure
terraform providers

terraform validate
terraform apply -auto-approve -input=false
