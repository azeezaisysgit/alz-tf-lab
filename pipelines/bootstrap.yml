trigger: none

pool:
  name: Default
  demands:
    - Agent.OS -equals Windows_NT

workspace:
  clean: all

variables:
  TF_VERSION: '1.6.6'

steps:
- checkout: self
  clean: true

- task: TerraformInstaller@1
  inputs:
    terraformVersion: $(TF_VERSION)

- task: AzureCLI@2
  displayName: Terraform Bootstrap
  inputs:
    azureSubscription: ALZ_SC_01
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $ErrorActionPreference = "Stop"

      Write-Host "===== REPO ROOT ====="
      Write-Host "PWD: $(Get-Location)"
      Get-ChildItem -Force

      Write-Host "===== GIT COMMIT ====="
      git rev-parse HEAD
      git log -1 --oneline

      if (!(Test-Path "0-bootstrap")) {
        throw "0-bootstrap folder not found"
      }

      Set-Location "0-bootstrap"

      Write-Host "===== 0-bootstrap CONTENTS ====="
      Get-ChildItem -Force

      Write-Host "===== main.tf ====="
      Get-Content ".\main.tf"

      Write-Host "===== backend.tf ====="
      Get-Content ".\backend.tf"

      if (Test-Path ".terraform") {
        Remove-Item ".terraform" -Recurse -Force
      }

      if (Test-Path ".terraform.lock.hcl") {
        Remove-Item ".terraform.lock.hcl" -Force
      }

      terraform -version
      terraform init -input=false -reconfigure -upgrade
      terraform validate
      terraform apply -auto-approve -input=false
